<?php
namespace Controllers;

use OpenApi\Annotations as OA;
use Middlewares\AuthMiddleware;
use Models\GalleryModel;
use Models\ExhibitionModel;

/**
 * @OA\Tag(
 *   name="GalleryConsole",
 *   description="[콘솔] 관리자 측 갤러리 관련 API"
 * )
 */
class GalleryConsoleController {
    private $authMiddleware;    
    private $galleryModel;
    private $exhibitionModel;

    public function __construct() {
        $this->authMiddleware = new AuthMiddleware();
        $this->galleryModel = new GalleryModel();
        $this->exhibitionModel = new ExhibitionModel();
    }

        try {
            $decoded = $this->authMiddleware->requireAdmin();

            // [버그 수정] $user_id가 정의되지 않았습니다.
            // $decoded 객체에서 실제 사용자 ID를 가져와야 합니다. (예: $decoded->user_id 또는 $decoded->sub)
            // 여기서는 $decoded->user_id라고 가정하겠습니다.
            $user_id = $decoded->user_id; 

            // [기능 추가] 'gallery_name' GET 파라미터를 읽어옵니다.
            $galleryName = $_GET['gallery_name'] ?? null;

            // [로직 개선] 모델에 전달할 필터 배열을 구성합니다.
            $filters = ['user_id' => $user_id];
            if (!empty($galleryName)) {
                $filters['gallery_name'] = $galleryName;
            }

            // [성능 개선] N+1 쿼리 문제 해결
            // getGalleries 메소드가 필터 배열을 받아 한 번의 쿼리로 모든 데이터를 가져오도록 합니다.
            // (기존의 비효율적인 foreach 루프를 제거합니다.)
            $galleries = $this->galleryModel->getGalleries($filters);

            // 기존 로직은 유지 (빈 배열 반환)
            if (empty($galleries)) {
                header('Content-Type: application/json');
                echo json_encode([], JSON_UNESCAPED_UNICODE);
                return;
            }

            // [성능 개선] 불필요한 루프를 제거했으므로, $galleries를 바로 반환합니다.
            header('Content-Type: application/json');
            echo json_encode($galleries, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

        } catch (\Exception $e) {
            http_response_code(500);
            error_log($e->getMessage());
            echo json_encode(['message' => '서버 오류가 발생했습니다.']);
        }
    }

    /**
     * @OA\Get(
     *   path="/api/console/galleries/{id}",
     *   summary="[콘솔] 갤러리 상세 조회",
     *   description="특정 갤러리의 상세 정보와 해당 갤러리에서 진행 중/예정 전시 목록을 함께 조회합니다.",
     *   tags={"GalleryConsole"},
     *   security={{"bearerAuth":{}}},
     *   @OA\Parameter(
     *     name="id",
     *     in="path",
     *     required=true,
     *     @OA\Schema(type="integer", example=1),
     *     description="조회할 갤러리 ID"
     *   ),
     *   @OA\Response(
     *     response=200,
     *     description="상세 조회 성공",
     *     @OA\JsonContent(
     *       type="object",
     *       @OA\Property(property="gallery_name", type="string"),
     *       @OA\Property(property="gallery_image", type="string"),
     *       @OA\Property(property="gallery_address", type="string"),
     *       @OA\Property(property="gallery_start_time", type="string"),
     *       @OA\Property(property="gallery_end_time", type="string"),
     *       @OA\Property(property="gallery_closed_day", type="string"),
     *       @OA\Property(property="gallery_category", type="string"),
     *       @OA\Property(property="gallery_description", type="string"),
     *       @OA\Property(property="gallery_latitude", type="number", format="float"),
     *       @OA\Property(property="gallery_longitude", type="number", format="float"),
     *       @OA\Property(property="gallery_phone", type="string"),
     *       @OA\Property(property="gallery_email", type="string"),
     *       @OA\Property(property="gallery_homepage", type="string"),
     *       @OA\Property(property="gallery_sns", type="string"),
     *       @OA\Property(
     *         property="exhibitions",
     *         type="array",
     *         description="해당 갤러리의 전시 목록",
     *         @OA\Items(
     *           type="object",
     *           @OA\Property(property="id", type="integer", example=101, description="전시 ID"),
     *           @OA\Property(property="title", type="string", example="빛의 향연", description="전시 제목"),
     *           @OA\Property(property="start_date", type="string", format="date", example="2025-11-01", description="전시 시작일"),
     *           @OA\Property(property="end_date", type="string", format="date", example="2025-11-30", description="전시 종료일"),
     *           @OA\Property(property="status", type="string", example="upcoming", description="upcoming/current/past")
     *         )
     *       )
     *     )
     *   ),
     *   @OA\Response(
     *     response=404,
     *     description="갤러리 없음",
     *     @OA\JsonContent(
     *       type="object",
     *       @OA\Property(property="message", type="string", example="Gallery not found")
     *     )
     *   )
     * )
     */
    public function getGalleryById($id) {
        $decoded = $this->authMiddleware->requireAdmin();
        $user_id = $decoded->sub;

        $gallery = $this->galleryModel->getById($id);

        if ($gallery) {
            $filters = ['gallery_id' => $id];
            $exhibitions = $this->exhibitionModel->getExhibitions($filters);

            if (is_object($gallery)) {
                $gallery->exhibitions = $exhibitions;
            } elseif (is_array($gallery)) {
                $gallery['exhibitions'] = $exhibitions;
            }

            header('Content-Type: application/json');
            echo json_encode($gallery, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
        } else {
            http_response_code(404);
            echo json_encode(['message' => 'Gallery not found']);
        }
    }
}
